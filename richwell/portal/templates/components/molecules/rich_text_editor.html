{# Rich Text Editor Molecule - WYSIWYG content editing #}
{#
  Props:
  - label: field label (required)
  - name: input name attribute (required)
  - id: input id attribute (optional, defaults to name)
  - value: current HTML content value (optional)
  - placeholder: placeholder text (optional)
  - required: whether field is required (default: False)
  - disabled: whether field is disabled (default: False)
  - min_height: minimum editor height - "sm" (150px), "md" (250px), "lg" (400px) (default: "md")
  - error: error message to display (optional)
  - help_text: helper text below field (optional)
  - toolbar: show formatting toolbar (default: True)
  - toolbar_items: list of toolbar items to show (optional)
    Available: bold, italic, underline, strikethrough, h1, h2, h3, ul, ol, link, image, code

  Usage:
  {% include "components/molecules/rich_text_editor.html" with
    label="Description"
    name="description"
    required=True
  %}

  Advanced usage with custom toolbar:
  {% include "components/molecules/rich_text_editor.html" with
    label="Content"
    name="content"
    toolbar_items="bold,italic,link,ul,ol"
    min_height="lg"
  %}
#}

{% load static %}

{# Set defaults #}
{% with
  editor_id=id|default:name
  editor_value=value|default:""
  editor_placeholder=placeholder|default:"Start typing..."
  editor_required=required|default:False
  editor_disabled=disabled|default:False
  editor_min_height=min_height|default:"md"
  editor_error=error|default:""
  editor_help=help_text|default:""
  editor_toolbar=toolbar|default:True
  editor_toolbar_items=toolbar_items|default:"bold,italic,underline,h2,h3,ul,ol,link"
%}


<div
  class="w-full"
  x-data="{
    content: `{{ editor_value|escapejs }}`,
    focused: false,

    init() {
      // Initialize content
      const editor = this.$refs.editor;
      if (this.content) {
        editor.innerHTML = this.content;
      }

      // Update hidden input when content changes
      editor.addEventListener('input', () => {
        this.content = editor.innerHTML;
        this.$refs.hiddenInput.value = editor.innerHTML;
      });
    },

    execCommand(command, value = null) {
      document.execCommand(command, false, value);
      this.$refs.editor.focus();
    },

    insertLink() {
      const url = prompt('Enter URL:');
      if (url) {
        this.execCommand('createLink', url);
      }
    },

    insertImage() {
      const url = prompt('Enter image URL:');
      if (url) {
        this.execCommand('insertImage', url);
      }
    },

    formatBlock(tag) {
      this.execCommand('formatBlock', tag);
    },

    isCommandActive(command) {
      try {
        return document.queryCommandState(command);
      } catch (e) {
        return false;
      }
    }
  }"
>
  {# Label #}
  <label for="{{ editor_id }}" class="block text-sm font-medium text-gray-700 mb-2">
    {{ label }}
    {% if editor_required %}
      <span class="text-red-500">*</span>
    {% endif %}
  </label>

  {# Toolbar #}
  {% if editor_toolbar and not editor_disabled %}
  <div class="border border-gray-300 rounded-t-lg bg-gray-50 p-2 flex flex-wrap gap-1">
    <!-- Bold -->
    {% if "bold" in editor_toolbar_items %}
    <button
      type="button"
      @click="execCommand('bold')"
      :class="{ 'bg-blue-100 text-blue-700': isCommandActive('bold') }"
      class="p-2 hover:bg-gray-200 rounded transition"
      title="Bold (Ctrl+B)"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 4h8a4 4 0 014 4 4 4 0 01-4 4H6V4zm0 8h9a4 4 0 014 4 4 4 0 01-4 4H6v-8z"/>
      </svg>
    </button>
    {% endif %}

    <!-- Italic -->
    {% if "italic" in editor_toolbar_items %}
    <button
      type="button"
      @click="execCommand('italic')"
      :class="{ 'bg-blue-100 text-blue-700': isCommandActive('italic') }"
      class="p-2 hover:bg-gray-200 rounded transition"
      title="Italic (Ctrl+I)"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 4h8M6 20h8m-2-16l-4 16"/>
      </svg>
    </button>
    {% endif %}

    <!-- Underline -->
    {% if "underline" in editor_toolbar_items %}
    <button
      type="button"
      @click="execCommand('underline')"
      :class="{ 'bg-blue-100 text-blue-700': isCommandActive('underline') }"
      class="p-2 hover:bg-gray-200 rounded transition"
      title="Underline (Ctrl+U)"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v9a5 5 0 0010 0V4M5 20h14"/>
      </svg>
    </button>
    {% endif %}

    <!-- Strikethrough -->
    {% if "strikethrough" in editor_toolbar_items %}
    <button
      type="button"
      @click="execCommand('strikeThrough')"
      :class="{ 'bg-blue-100 text-blue-700': isCommandActive('strikeThrough') }"
      class="p-2 hover:bg-gray-200 rounded transition"
      title="Strikethrough"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12h18M9 5L7 19m10-14l-2 14"/>
      </svg>
    </button>
    {% endif %}

    <div class="border-l border-gray-300 mx-1"></div>

    <!-- Heading 1 -->
    {% if "h1" in editor_toolbar_items %}
    <button
      type="button"
      @click="formatBlock('h1')"
      class="px-3 py-2 hover:bg-gray-200 rounded font-bold transition"
      title="Heading 1"
    >
      H1
    </button>
    {% endif %}

    <!-- Heading 2 -->
    {% if "h2" in editor_toolbar_items %}
    <button
      type="button"
      @click="formatBlock('h2')"
      class="px-3 py-2 hover:bg-gray-200 rounded font-bold transition"
      title="Heading 2"
    >
      H2
    </button>
    {% endif %}

    <!-- Heading 3 -->
    {% if "h3" in editor_toolbar_items %}
    <button
      type="button"
      @click="formatBlock('h3')"
      class="px-3 py-2 hover:bg-gray-200 rounded font-bold transition"
      title="Heading 3"
    >
      H3
    </button>
    {% endif %}

    <div class="border-l border-gray-300 mx-1"></div>

    <!-- Unordered List -->
    {% if "ul" in editor_toolbar_items %}
    <button
      type="button"
      @click="execCommand('insertUnorderedList')"
      :class="{ 'bg-blue-100 text-blue-700': isCommandActive('insertUnorderedList') }"
      class="p-2 hover:bg-gray-200 rounded transition"
      title="Bullet List"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
      </svg>
    </button>
    {% endif %}

    <!-- Ordered List -->
    {% if "ol" in editor_toolbar_items %}
    <button
      type="button"
      @click="execCommand('insertOrderedList')"
      :class="{ 'bg-blue-100 text-blue-700': isCommandActive('insertOrderedList') }"
      class="p-2 hover:bg-gray-200 rounded transition"
      title="Numbered List"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5h12M9 12h12M9 19h12M3 5h.01M3 12h.01M3 19h.01"/>
      </svg>
    </button>
    {% endif %}

    <div class="border-l border-gray-300 mx-1"></div>

    <!-- Link -->
    {% if "link" in editor_toolbar_items %}
    <button
      type="button"
      @click="insertLink()"
      class="p-2 hover:bg-gray-200 rounded transition"
      title="Insert Link"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
      </svg>
    </button>
    {% endif %}

    <!-- Image -->
    {% if "image" in editor_toolbar_items %}
    <button
      type="button"
      @click="insertImage()"
      class="p-2 hover:bg-gray-200 rounded transition"
      title="Insert Image"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
      </svg>
    </button>
    {% endif %}

    <!-- Code -->
    {% if "code" in editor_toolbar_items %}
    <button
      type="button"
      @click="formatBlock('pre')"
      class="p-2 hover:bg-gray-200 rounded transition font-mono"
      title="Code Block"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
      </svg>
    </button>
    {% endif %}
  </div>
  {% endif %}

  {# Editor Area #}
  <div
    x-ref="editor"
    contenteditable="{{ editor_disabled|yesno:'false,true' }}"
    @focus="focused = true"
    @blur="focused = false"
    :placeholder="content ? '' : '{{ editor_placeholder }}'"
    class="block w-full px-4 py-3 border {% if editor_min_height == 'sm' %}min-h-[150px]{% elif editor_min_height == 'lg' %}min-h-[400px]{% else %}min-h-[250px]{% endif %} overflow-y-auto focus:outline-none focus:ring-2 focus:ring-blue-500 transition
      {% if editor_toolbar %}border-t-0 rounded-b-lg{% else %}rounded-lg{% endif %}
      {% if editor_error %}border-red-300{% else %}border-gray-300{% endif %}
      {% if editor_disabled %}bg-gray-100 cursor-not-allowed text-gray-500{% else %}bg-white{% endif %}"
    :class="{ 'ring-2 ring-blue-500 border-transparent': focused && !{{ editor_disabled|yesno:'true,false' }} }"
    style="word-wrap: break-word;"
  ></div>

  {# Hidden Input (stores HTML) #}
  <input
    type="hidden"
    x-ref="hiddenInput"
    id="{{ editor_id }}"
    name="{{ name }}"
    :value="content"
    {% if editor_required %}required{% endif %}
  />

  {# Error Message #}
  {% if editor_error %}
  <p class="mt-2 text-sm text-red-600 flex items-center">
    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
    </svg>
    {{ editor_error }}
  </p>
  {% endif %}

  {# Help Text #}
  {% if editor_help and not editor_error %}
  <p class="mt-2 text-sm text-gray-500">{{ editor_help }}</p>
  {% endif %}

  {# Character/Word Count (Optional) #}
  <div class="mt-2 text-xs text-gray-500 flex justify-between">
    <span x-text="($refs.editor.textContent.length + ' characters')"></span>
    <span x-text="($refs.editor.textContent.trim().split(/\s+/).filter(w => w).length + ' words')"></span>
  </div>
</div>

<style>
  /* Placeholder styling */
  [contenteditable]:empty:before {
    content: attr(placeholder);
    color: #9CA3AF;
    font-style: italic;
  }

  /* Editor content styling */
  [contenteditable] {
    outline: none;
  }

  [contenteditable] h1 {
    font-size: 1.875rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  [contenteditable] h2 {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  [contenteditable] h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  [contenteditable] p {
    margin-bottom: 0.75rem;
  }

  [contenteditable] ul,
  [contenteditable] ol {
    margin-left: 1.5rem;
    margin-bottom: 0.75rem;
  }

  [contenteditable] ul {
    list-style-type: disc;
  }

  [contenteditable] ol {
    list-style-type: decimal;
  }

  [contenteditable] li {
    margin-bottom: 0.25rem;
  }

  [contenteditable] a {
    color: #2563EB;
    text-decoration: underline;
  }

  [contenteditable] img {
    max-width: 100%;
    height: auto;
    margin: 0.5rem 0;
  }

  [contenteditable] pre {
    background-color: #F3F4F6;
    padding: 0.75rem;
    border-radius: 0.375rem;
    overflow-x: auto;
    font-family: monospace;
    margin-bottom: 0.75rem;
  }
</style>

{% endwith %}
